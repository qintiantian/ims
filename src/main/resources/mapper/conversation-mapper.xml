<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xylink.mappers.ConversationDao">
    <insert id="insertConversation" parameterType="com.xylink.entity.ConversationVO">
      insert into ims_conversation(conversation_id,user_id,dest_id,conversation_type,status,ts, last_date)
      values(#{conversationId},#{userId},#{destId},#{conversationType},#{status},#{ts}, #{lastDate})
    </insert>

    <select id="selectConversationByUserId" resultType="java.util.HashMap">
        select u.img_url as imgUrl, u.nickname, d.destId, u.username, d.last_date as lastDate, d.content as lastMsg, d.msg_id as msgId
            from ims_user u join
            (select m.msg_id, m.content,c.last_date, (CASE
            WHEN c.user_id = #{userId} THEN
                c.dest_id
            ELSE
                c.user_id
            END) as destId
            from ims_conversation c join ims_msg m
            on c.conversation_id = m.conversation_id
             where c.user_id=#{userId} or c.dest_id=#{userId}
            group by m.conversation_id) as d
        on u.user_id = d.destId
        where u.status=1
        order by d.last_date desc
    </select>

    <select id="selConversation" resultType="com.xylink.entity.ConversationVO">
        select * from ims_conversation c
        where (c.user_id=#{sendId} and c.dest_id=#{destId}) or (c.user_id=#{destId} and c.dest_id=#{sendId})
    </select>

</mapper>